#!/bin/sh
## Preinstall script

## unload com.facebook.osqueryd
sudo /bin/launchctl unload -w "/Library/LaunchDaemons/com.facebook.osqueryd.plist" > /dev/null

# detect client device serial_number
CLIENT_ID=$(/usr/sbin/system_profiler SPHardwareDataType | awk '/Serial/ {print $4}')

# create directory for osquery and rocksDB
/bin/mkdir -p "/usr/local/zentral/osquery"
/usr/sbin/chown -R root:admin "/usr/local/zentral"

# create osquery enrollment file from a secret, with osquery key "", insert clients serial_number as ID
echo "%OSQUERY_SECRET_SECRET%\$SERIAL\$${CLIENT_ID}" > /usr/local/zentral/enroll_secret.txt

/bin/chmod 400 /usr/local/zentral/enroll_secret.txt
/usr/sbin/chown root:admin "/usr/local/zentral/enroll_secret.txt"

exit 0
